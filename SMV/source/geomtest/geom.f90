! Routines related to unstructured geometry and immersed boundary methods

MODULE TYPES
USE PRECISION_PARAMETERS

TYPE GEOMETRY_TYPE
   CHARACTER(30) :: ID='geom',SMVOBJECT='sensor',TFILE='null'
   CHARACTER(30) :: SHAPE='SPHERE',SURF_ID='null'
   CHARACTER(60) :: BNDC_FILENAME='null', GEOC_FILENAME='null'   
   REAL(EB) :: X1=0._EB,X2=0._EB,Y1=0._EB,Y2=0._EB,Z1=0._EB,Z2=0._EB
   REAL(EB) :: X0=0._EB,Y0=0._EB,Z0=0._EB,X=0._EB,Y=0._EB,Z=0._EB,XOR=0._EB,YOR=0._EB,ZOR=0._EB
   REAL(EB) :: RADIUS=1.E6_EB
   REAL(EB) :: U0=0._EB,V0=0._EB,W0=0._EB,U=0._EB,V=0._EB,W=0._EB
   REAL(EB) :: OMEGA=0._EB ! rotation rate (rad/s) about orientation axis
   REAL(EB) :: OMEGA_X=0._EB,OMEGA_Y=0._EB,OMEGA_Z=0._EB ! rotation rate about grid basis vectors
   LOGICAL :: TRANSLATE=.FALSE.,ROTATE=.FALSE.,HOLE=.FALSE.,TWO_SIDED=.FALSE.
   INTEGER :: ISHAPE
   INTEGER, ALLOCATABLE, DIMENSION(:) :: MIN_I,MAX_I,MIN_J,MAX_J,MIN_K,MAX_K
   INTEGER, DIMENSION(3) :: RGB=(/192,192,192/)
   REAL(EB), DIMENSION(3) :: NN=(/0._EB,0._EB,0._EB/),HL=(/0.5_EB,0.5_EB,0.5_EB/)
   REAL(EB) :: PIXELS=1.0
   REAL(EB) :: ROUGHNESS
END TYPE GEOMETRY_TYPE
TYPE(GEOMETRY_TYPE), ALLOCATABLE, TARGET, DIMENSION(:) :: GEOMETRY
END MODULE TYPES

MODULE COMPLEX_GEOMETRY

USE PRECISION_PARAMETERS
USE TYPES
USE GLOBAL_CONSTANTS
USE MESH_VARIABLES
USE MESH_POINTERS
USE COMP_FUNCTIONS, ONLY: CHECKREAD,SHUTDOWN
USE MEMORY_FUNCTIONS, ONLY: ChkMemErr

IMPLICIT NONE

PRIVATE
PUBLIC :: READ_GEOM
 
CONTAINS

SUBROUTINE READ_GEOM

INTEGER :: N_GEOM
CHARACTER(30) :: ID,GEOM_ID,SURF_ID
REAL(EB) :: X(3)
INTEGER :: F(3),N_VERT
INTEGER :: IOS,IZERO,N
TYPE(GEOMETRY_TYPE), POINTER :: G=>NULL()
NAMELIST /GEOM/ F,GEOM_ID,ID,N_VERT,SURF_ID,X

INTEGER :: LU_INPUT

N_GEOM=0
REWIND(LU_INPUT)
COUNT_GEOM_LOOP: DO
   CALL CHECKREAD('GEOM',LU_INPUT,IOS)
   IF (IOS==1) EXIT COUNT_GEOM_LOOP
   READ(LU_INPUT,NML=GEOM,END=11,ERR=12,IOSTAT=IOS)
   N_GEOM=N_GEOM+1
   12 IF (IOS>0) CALL SHUTDOWN('ERROR: problem with GEOM line')
ENDDO COUNT_GEOM_LOOP
11 REWIND(LU_INPUT)

IF (N_GEOM==0) RETURN

! Allocate GEOMETRY array

ALLOCATE(GEOMETRY(N_GEOM),STAT=IZERO)
CALL ChkMemErr('READ','GEOMETRY',IZERO)

READ_GEOM_LOOP: DO N=1,N_GEOM
   G=>GEOMETRY(N)
   
   CALL CHECKREAD('GEOM',LU_INPUT,IOS)
   IF (IOS==1) EXIT READ_GEOM_LOOP
   
   ! Set defaults
   
   ID = 'geom'
   SURF_ID = 'INERT'

   ! Read the GEOM line
   
   READ(LU_INPUT,GEOM,END=35)
   
   G%ID = ID
   
ENDDO READ_GEOM_LOOP
35 REWIND(LU_INPUT)

END SUBROUTINE READ_GEOM



END MODULE COMPLEX_GEOMETRY
