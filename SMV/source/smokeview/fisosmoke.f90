! $Date$ 
! $Revision$
! $Author$

! ------------------ FISOSURFACE2FILE ------------------------

SUBROUTINE FISOSURFACE2FILE(LU_ISO,T,FIRST,VDATA,HAVE_TDATA,TDATA,HAVE_IBLANK,IBLANK,&
           LEVEL, NLEVELS, XPLT, NX, YPLT, NY, ZPLT, NZ, ERROR)
  IMPLICIT NONE
           
  INTEGER, INTENT(IN) :: LU_ISO, FIRST
  REAL, INTENT(IN) :: T
  INTEGER, INTENT(IN) :: HAVE_TDATA, HAVE_IBLANK
  REAL, INTENT(IN), DIMENSION(0:NX,0:NY,0:NZ) :: VDATA,TDATA
  INTEGER, INTENT(IN), DIMENSION(0:NX-1,0:NY-1,0:NZ-1) :: IBLANK
  INTEGER, INTENT(IN) :: NLEVELS
  REAL, INTENT(IN), DIMENSION(0:NLEVELS-1) :: LEVEL
  INTEGER, INTENT(IN) :: NX, NY, NZ
  REAL, INTENT(IN), DIMENSION(0:NX) :: XPLT
  REAL, INTENT(IN), DIMENSION(0:NY) :: YPLT
  REAL, INTENT(IN), DIMENSION(0:NZ) :: ZPLT
  INTEGER, INTENT(OUT) :: ERROR
  
           
  INTEGER :: I
  INTEGER :: FGETISOSURFACE
  INTEGER :: NXYZVERTS, NTRIANGLES
  REAL, DIMENSION(:), POINTER :: XYZVERTS
  INTEGER, DIMENSION(:), POINTER :: TRIANGLES
  
  ERROR=0
  DO I =0, NLEVELS-1
    IF(FGETISOSURFACE(VDATA, HAVE_TDATA, TDATA, HAVE_IBLANK, IBLANK, LEVEL(I), &
          XPLT, NX, YPLT, NY, ZPLT, NZ,XYZVERTS, NXYZVERTS, TRIANGLES, NTRIANGLES)==1)THEN
      ERROR=1
      RETURN
    ENDIF
    !IF(COMPRESSISOSURFACE(&SURFACE,*REDUCE_TRIANGLES,
    !  XPLT[0],XPLT[*NX-1],YPLT[0],YPLT[*NY-1],ZPLT[0],ZPLT[*NZ-1]).NE.0)THEN
    !  ERROR=1;
    !  RETURN;
    !ENDIF
    CALL FISOOUT(LU_ISO,FIRST,T,I,XYZVERTS,NXYZVERTS,TRIANGLES,NTRIANGLES)
    IF(NXYZVERTS.GT.0)THEN
      DEALLOCATE(XYZVERTS)
    ENDIF
    IF(NTRIANGLES.GT.0)THEN
      DEALLOCATE(TRIANGLES)
    ENDIF
  END DO
  RETURN
END SUBROUTINE FISOSURFACE2FILE

! ------------------ FISOSURFACE2FILE ------------------------

SUBROUTINE FISOOUT(ISOFILE,FIRST,STIME,ILEVEL,XYZVERTS,NXYZVERTS,TRIANGLES,NTRIANGLES,ERROR)
  IMPLICIT NONE
  CHARACTER(LEN=*), INTENT(IN) :: ISOFILE
  INTEGER, INTENT(IN) :: FIRST
  REAL, INTENT(IN) :: STIME
  INTEGER, INTENT(IN) :: ILEVEL
  INTEGER, INTENT(OUT) :: ERROR
  INTEGER, INTENT(IN) :: NXYZVERTS, NTRIANGLES
  REAL, INTENT(IN), DIMENSION(:), POINTER :: XYZVERTS
  INTEGER, INTENT(IN), DIMENSION(:), POINTER :: TRIANGLES
  
  INTEGER :: LU_GEOM=10
  INTEGER :: VERSION=1
  INTEGER :: GEOM_TYPE=0
  INTEGER :: I
  INTEGER :: ONE=1

  IF(FIRST.EQ.1)THEN  
    WRITE(LU_GEOM) ONE
    WRITE(LU_GEOM) VERSION
    WRITE(LU_GEOM) STIME ! first time step
    WRITE(LU_GEOM) 0,0,NXYZVERTS,NTRIANGLES
    IF (NXYZVERTS>0) WRITE(LU_GEOM) (XYZVERTS(I),I=0,3*NXYZVERTS-1)
    IF (NTRIANGLES>0) WRITE(LU_GEOM) (TRIANGLES(I),I=0,3*NTRIANGLES-1)
    IF (NTRIANGLES>0) WRITE(LU_GEOM) (ILEVEL,I=0,NTRIANGLES-1)
  ELSE
    WRITE(LU_GEOM) STIME, GEOM_TYPE ! each successive time step (if there is time dependent geometry)
    WRITE(LU_GEOM) NXYZVERTS,NTRIANGLES
    IF (NXYZVERTS>0) WRITE(LU_GEOM) (XYZVERTS(I),I=0,3*NXYZVERTS-1)
    IF (NTRIANGLES>0) WRITE(LU_GEOM) (TRIANGLES(I),I=0,3*NTRIANGLES-1)
    IF (NTRIANGLES>0) WRITE(LU_GEOM) (ILEVEL,I=0,NTRIANGLES-1)
  ENDIF
  ERROR=0
          
  RETURN
END SUBROUTINE FISOOUT           

!  ------------------ FGETISOSURFACE ------------------------ 

INTEGER FUNCTION FGETISOSURFACE(VDATA, HAVE_TDATA, TDATA, HAVE_IBLANK, IBLANK_CELL, LEVEL, &
     XPLT, NX, YPLT, NY, ZPLT, NZ,&
     XYZVERTS, NXYZVERTS, TRIANGLES, NTRIANGLES)

  IMPLICIT NONE
     
  INTEGER, INTENT(IN) :: NX, NY, NZ
  INTEGER, INTENT(IN) :: HAVE_TDATA, HAVE_IBLANK
  REAL, DIMENSION(0:NX,0:NY,0:NZ), INTENT(IN) :: VDATA, TDATA
  INTEGER, DIMENSION(0:NX-1,0:NY-1,0:NZ-1), INTENT(IN) :: IBLANK_CELL
  REAL, INTENT(IN) :: LEVEL
  REAL, INTENT(IN), DIMENSION(0:NX) :: XPLT
  REAL, INTENT(IN), DIMENSION(0:NY) :: YPLT
  REAL, INTENT(IN), DIMENSION(0:NZ) :: ZPLT
     
  REAL, DIMENSION(:), POINTER, INTENT(OUT) :: XYZVERTS
  INTEGER, DIMENSION(:), POINTER, INTENT(OUT) :: TRIANGLES
  INTEGER, INTENT(OUT) :: NTRIANGLES, NXYZVERTS
  
  
  REAL, DIMENSION(0:1) :: XX, YY, ZZ
  INTEGER, DIMENSION(0:23) :: NODEINDEXES
  INTEGER, DIMENSION(0:35) :: CLOSESTNODES
  REAL, DIMENSION(0:7) :: VALS, TVALS
  REAL, DIMENSION(0:35) :: XYZV,TV
  INTEGER :: NXYZV
  INTEGER, DIMENSION(0:11) :: TRIS
  INTEGER :: NTRIS
  INTEGER :: NXYZVERTS_MAX, NTRIANGLES_MAX
  REAL :: VMIN, VMAX
  
  INTEGER :: I, J, K, N
  INTEGER :: RETURNVAL
  INTEGER :: FGETISOBOX,UPDATEISOSURFACE
     
  INTEGER, DIMENSION(0:3) :: IXMIN=(/0,1,4,5/), IXMAX=(/2,3,6,7/)
  INTEGER, DIMENSION(0:3) :: IYMIN=(/0,3,4,7/), IYMAX=(/1,2,5,6/)
  INTEGER, DIMENSION(0:3) :: IZMIN=(/0,1,2,3/), IZMAX=(/4,5,6,7/)
  
  NULLIFY(XYZVERTS)
  NULLIFY(TRIANGLES)
  NTRIANGLES=0
  NXYZVERTS=0
  NXYZVERTS_MAX=1000
  NTRIANGLES_MAX=1000
  ALLOCATE(XYZVERTS(3*NXYZVERTS_MAX))
  ALLOCATE(TRIANGLES(3*NTRIANGLES_MAX))
     
  DO I=0, NX-2
    XX(0)=XPLT(I)
    XX(1)=XPLT(I+1)
    DO J=0,NY-2
      YY(0)=YPLT(J);
      YY(1)=YPLT(J+1);
      DO K=0,NZ-2
        IF(HAVE_IBLANK.EQ.1.AND.IBLANK_CELL(I,J,K).EQ.0)CONTINUE
        
        VALS(0)=VDATA(  I,  J,  K)
        VALS(1)=VDATA(  I,J+1,  K)
        VALS(2)=VDATA(I+1,J+1,  K)
        VALS(3)=VDATA(I+1,  J,  K)
        VALS(4)=VDATA(  I,  J,K+1)
        VALS(5)=VDATA(  I,J+1,K+1)
        VALS(6)=VDATA(I+1,J+1,K+1)
        VALS(7)=VDATA(I+1,  J,K+1)

        VMIN=MIN(VALS(0),VALS(1),VALS(2),VALS(3),VALS(4),VALS(5),VALS(6),VALS(7))
        VMAX=MAX(VALS(0),VALS(1),VALS(2),VALS(3),VALS(4),VALS(5),VALS(6),VALS(7))
        IF(VMIN.GT.LEVEL.OR.VMAX.LT.LEVEL)CONTINUE
           
        ZZ(0)=ZPLT(K);
        ZZ(1)=ZPLT(K+1);

        DO N=0, 3
          NODEINDEXES(3*IXMIN(N))=I
          NODEINDEXES(3*IXMAX(N))=I+1
          NODEINDEXES(3*IYMIN(N)+1)=J
          NODEINDEXES(3*IYMAX(N)+1)=J+1
          NODEINDEXES(3*IZMIN(N)+2)=K
          NODEINDEXES(3*IZMAX(N)+2)=K+1
        END DO

        IF(HAVE_TDATA.EQ.1)THEN
          TVALS(0)=TDATA(  I,  J,  K)
          TVALS(1)=TDATA(  I,J+1,  K)
          TVALS(2)=TDATA(I+1,J+1,  K)
          TVALS(3)=TDATA(I+1,  J,  K)
          TVALS(4)=TDATA(  I,  J,K+1)
          TVALS(5)=TDATA(  I,J+1,K+1)
          TVALS(6)=TDATA(I+1,J+1,K+1)
          TVALS(7)=TDATA(I+1,  J,K+1)
        ENDIF

        RETURNVAL=FGETISOBOX(XX,YY,ZZ,VALS,HAVE_TDATA,TVALS,NODEINDEXES,LEVEL,XYZV,TV,NXYZV,TRIS,NTRIS,CLOSESTNODES)

        IF(NXYZV.GT.0.OR.NTRIS.GT.0)THEN
          IF(UPDATEISOSURFACE(XYZV, NXYZV, TRIS, NTRIS, CLOSESTNODES, XYZVERTS, NXYZVERTS, NXYZVERTS_MAX, TRIANGLES, NTRIANGLES, NTRIANGLES_MAX).NE.0)THEN
            FGETISOSURFACE=1
            RETURN
          ENDIF
        ENDIF
      END DO
    END DO
  END DO
  FGETISOSURFACE=0
  RETURN     
END FUNCTION FGETISOSURFACE

!  ------------------ UPDATEISOSURFACE ------------------------ 

INTEGER FUNCTION UPDATEISOSURFACE(XYZV, NXYZV, TRIS, NTRIS, CLOSESTNODES, XYZVERTS, NXYZVERTS, NXYZVERTS_MAX, TRIANGLES, NTRIANGLES, NTRIANGLES_MAX)
  REAL, INTENT(IN), DIMENSION(0:3*NXYZV-1) :: XYZV
  INTEGER, INTENT(IN), DIMENSION(0:3*NTRIS-1) :: TRIS
  INTEGER, INTENT(IN), DIMENSION(:) :: CLOSESTNODES
  REAL, INTENT(INOUT), POINTER, DIMENSION(:) :: XYZVERTS
  INTEGER, INTENT(INOUT) :: NXYZVERTS, NXYZVERTS_MAX, NTRIANGLES, NTRIANGLES_MAX
  INTEGER, INTENT(INOUT), POINTER, DIMENSION(:) :: TRIANGLES
  REAL, DIMENSION(:), POINTER :: XYZVERTS_TEMP
  INTEGER, DIMENSION(:), POINTER :: TRIANGLES_TEMP
  
  IF(NXYZVERTS+NXYZV.GT.NXYZVERTS_MAX)THEN
    NXYZVERTS_MAX=NXYZVERTS_MAX+1000
    CALL REALLOCATE_F(XYZVERTS,3*NXYZVERTS,3*NXYZVERTS_MAX)
  ENDIF
  IF(NTRIANGLES+NTRIS.GT.NTRIANGLES_MAX)THEN
    NTRIANGLES_MAX=NTRIANGLES_MAX+1000
    CALL REALLOCATE_I(TRIANGLES,3*NTRIANGLES,3*NXYZVERTS_MAX)
  ENDIF
  XYZVERTS(3*NXYZVERTS:3*NXYZVERTS+3*NXYZV-1)=XYZV(0:3*NXYZV-1)
  TRIANGLES(3*NTRIANGLES:3*NTRIANGLES+3*NTRIS-1)=TRIS(0:3*NTRIS-1)
  UPDATEISOSURFACE=0
  RETURN
END FUNCTION UPDATEISOSURFACE

!  ------------------ FMIX ------------------------ 

REAL FUNCTION FMIX(F,A,B)
  IMPLICIT NONE
  REAL, INTENT(IN) :: F, A, B
  
    
  FMIX = (1.0-F)*A + F*B
  RETURN
END FUNCTION FMIX

!  ------------------ FGETISOBOX ------------------------ 

INTEGER FUNCTION FGETISOBOX(X,Y,Z,VALS,HAVE_TVALS,TVALS,NODEINDEXES,LEVEL,XYZV,TV,NXYZV,TRIS,NTRIS,CLOSESTNODES)
IMPLICIT NONE
REAL, DIMENSION(0:1), INTENT(IN) :: X, Y, Z
INTEGER, INTENT(IN) :: HAVE_TVALS
REAL, DIMENSION(0:7), INTENT(IN) :: VALS,TVALS
INTEGER, DIMENSION(0:23), INTENT(IN) :: NODEINDEXES
REAL, INTENT(IN) :: LEVEL
REAL, INTENT(OUT), DIMENSION(0:60) :: XYZV,TV
INTEGER, INTENT(OUT) :: NXYZV
INTEGER, INTENT(OUT), DIMENSION(0:60) :: TRIS
INTEGER, INTENT(OUT) :: NTRIS
INTEGER, DIMENSION(0:35), INTENT(OUT) :: CLOSESTNODES
REAL :: FMIX

INTEGER, DIMENSION(0:14) :: COMPCASE=(/0,0,0,-1,0,0,-1,-1,0,0,0,0,-1,-1,0/)
!INT COMPCASE[]=                      {0,0,0,-1,0,0,-1,-1,0,0,0,0,-1,-1,0};

INTEGER, DIMENSION(0:11,0:1) :: EDGE2VERTEX                                              
INTEGER, DIMENSION(0:1,0:11) :: EDGE2VERTEXT=(/0,1,1,2,2,3,0,3,&
                                              0,4,1,5,2,6,3,7,&
                                              4,5,5,6,6,7,4,7/)
!INT EDGE2VERTEX[12][2]={
!  {0,1},{1,2},{2,3},{0,3},
!  {0,4},{1,5},{2,6},{3,7},
!  {4,5},{5,6},{6,7},{4,7}
!};

INTEGER, POINTER, DIMENSION(:) :: CASE2
INTEGER, TARGET,DIMENSION(0:255,0:9) :: CASES
INTEGER, DIMENSION(0:9,0:255) :: CASEST=(/&
0,0,0,0,0,0,0,0, 0,  0,0,1,2,3,4,5,6,7, 1,  1,1,2,3,0,5,6,7,4, 1,  2,&
1,2,3,0,5,6,7,4, 2,  3,2,3,0,1,6,7,4,5, 1,  4,0,4,5,1,3,7,6,2, 3,  5,&
2,3,0,1,6,7,4,5, 2,  6,3,0,1,2,7,4,5,6, 5,  7,3,0,1,2,7,4,5,6, 1,  8,&
0,1,2,3,4,5,6,7, 2,  9,3,7,4,0,2,6,5,1, 3, 10,2,3,0,1,6,7,4,5, 5, 11,&
3,0,1,2,7,4,5,6, 2, 12,1,2,3,0,5,6,7,4, 5, 13,0,1,2,3,4,5,6,7, 5, 14,&
0,1,2,3,4,5,6,7, 8, 15,4,0,3,7,5,1,2,6, 1, 16,4,5,1,0,7,6,2,3, 2, 17,&
1,2,3,0,5,6,7,4, 3, 18,5,1,0,4,6,2,3,7, 5, 19,2,3,0,1,6,7,4,5, 4, 20,&
4,5,1,0,7,6,2,3, 6, 21,2,3,0,1,6,7,4,5, 6, 22,3,0,1,2,7,4,5,6,14, 23,&
4,5,1,0,7,6,2,3, 3, 24,7,4,0,3,6,5,1,2, 5, 25,2,6,7,3,1,5,4,0, 7, 26,&
3,0,1,2,7,4,5,6, 9, 27,2,6,7,3,1,5,4,0, 6, 28,4,0,3,7,5,1,2,6,11, 29,&
0,1,2,3,4,5,6,7,12, 30,0,0,0,0,0,0,0,0, 0,  0,5,4,7,6,1,0,3,2, 1, 32,&
0,3,7,4,1,2,6,5, 3, 33,1,0,4,5,2,3,7,6, 2, 34,4,5,1,0,7,6,2,3, 5, 35,&
2,3,0,1,6,7,4,5, 3, 36,3,7,4,0,2,6,5,1, 7, 37,6,2,1,5,7,3,0,4, 5, 38,&
0,1,2,3,4,5,6,7, 9, 39,3,0,1,2,7,4,5,6, 4, 40,3,7,4,0,2,6,5,1, 6, 41,&
5,6,2,1,4,7,3,0, 6, 42,3,0,1,2,7,4,5,6,11, 43,3,0,1,2,7,4,5,6, 6, 44,&
1,2,3,0,5,6,7,4,12, 45,0,1,2,3,4,5,6,7,14, 46,0,0,0,0,0,0,0,0, 0,  0,&
5,1,0,4,6,2,3,7, 2, 48,1,0,4,5,2,3,7,6, 5, 49,0,4,5,1,3,7,6,2, 5, 50,&
4,5,1,0,7,6,2,3, 8, 51,4,7,6,5,0,3,2,1, 6, 52,1,0,4,5,2,3,7,6,12, 53,&
4,5,1,0,7,6,2,3,11, 54,0,0,0,0,0,0,0,0, 0,  0,5,1,0,4,6,2,3,7, 6, 56,&
1,0,4,5,2,3,7,6,14, 57,0,4,5,1,3,7,6,2,12, 58,0,0,0,0,0,0,0,0, 0,  0,&
4,0,3,7,5,1,2,6,10, 60,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,6,7,3,2,5,4,0,1, 1, 64,0,1,2,3,4,5,6,7, 4, 65,&
1,0,4,5,2,3,7,6, 3, 66,0,4,5,1,3,7,6,2, 6, 67,2,1,5,6,3,0,4,7, 2, 68,&
6,7,3,2,5,4,0,1, 6, 69,5,6,2,1,4,7,3,0, 5, 70,0,1,2,3,4,5,6,7,11, 71,&
3,0,1,2,7,4,5,6, 3, 72,0,1,2,3,4,5,6,7, 6, 73,7,4,0,3,6,5,1,2, 7, 74,&
2,3,0,1,6,7,4,5,12, 75,7,3,2,6,4,0,1,5, 5, 76,1,2,3,0,5,6,7,4,14, 77,&
1,2,3,0,5,6,7,4, 9, 78,0,0,0,0,0,0,0,0, 0,  0,4,0,3,7,5,1,2,6, 3, 80,&
0,3,7,4,1,2,6,5, 6, 81,2,3,0,1,6,7,4,5, 7, 82,5,1,0,4,6,2,3,7,12, 83,&
2,1,5,6,3,0,4,7, 6, 84,0,1,2,3,4,5,6,7,10, 85,5,6,2,1,4,7,3,0,12, 86,&
0,0,0,0,0,0,0,0, 0,  0,0,1,2,3,4,5,6,7, 7, 88,7,4,0,3,6,5,1,2,12, 89,&
3,0,1,2,7,4,5,6,13, 90,0,0,0,0,0,0,0,0, 0,  0,7,3,2,6,4,0,1,5,12, 92,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
5,4,7,6,1,0,3,2, 2, 96,6,2,1,5,7,3,0,4, 6, 97,2,1,5,6,3,0,4,7, 5, 98,&
2,1,5,6,3,0,4,7,14, 99,1,5,6,2,0,4,7,3, 5,100,1,5,6,2,0,4,7,3,12,101,&
1,5,6,2,0,4,7,3, 8,102,0,0,0,0,0,0,0,0, 0,  0,5,4,7,6,1,0,3,2, 6,104,&
0,4,5,1,3,7,6,2,10,105,2,1,5,6,3,0,4,7,12,106,0,0,0,0,0,0,0,0, 0,  0,&
5,6,2,1,4,7,3,0,11,108,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,7,6,5,4,3,2,1,0, 5,112,0,4,5,1,3,7,6,2,11,113,&
6,5,4,7,2,1,0,3, 9,114,0,0,0,0,0,0,0,0, 0,  0,1,5,6,2,0,4,7,3,14,116,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
7,6,5,4,3,2,1,0,12,120,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,7,6,5,4,3,2,1,0, 1,128,&
0,1,2,3,4,5,6,7, 3,129,1,2,3,0,5,6,7,4, 4,130,1,2,3,0,5,6,7,4, 6,131,&
7,4,0,3,6,5,1,2, 3,132,1,5,6,2,0,4,7,3, 7,133,1,5,6,2,0,4,7,3, 6,134,&
3,0,1,2,7,4,5,6,12,135,3,2,6,7,0,1,5,4, 2,136,4,0,3,7,5,1,2,6, 5,137,&
7,4,0,3,6,5,1,2, 6,138,2,3,0,1,6,7,4,5,14,139,6,7,3,2,5,4,0,1, 5,140,&
2,3,0,1,6,7,4,5, 9,141,1,2,3,0,5,6,7,4,11,142,0,0,0,0,0,0,0,0, 0,  0,&
4,0,3,7,5,1,2,6, 2,144,3,7,4,0,2,6,5,1, 5,145,7,6,5,4,3,2,1,0, 6,146,&
1,0,4,5,2,3,7,6,11,147,4,0,3,7,5,1,2,6, 6,148,3,7,4,0,2,6,5,1,12,149,&
1,0,4,5,2,3,7,6,10,150,0,0,0,0,0,0,0,0, 0,  0,0,3,7,4,1,2,6,5, 5,152,&
4,0,3,7,5,1,2,6, 8,153,0,3,7,4,1,2,6,5,12,154,0,0,0,0,0,0,0,0, 0,  0,&
0,3,7,4,1,2,6,5,14,156,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,5,1,0,4,6,2,3,7, 3,160,1,2,3,0,5,6,7,4, 7,161,&
1,0,4,5,2,3,7,6, 6,162,4,5,1,0,7,6,2,3,12,163,3,0,1,2,7,4,5,6, 7,164,&
0,1,2,3,4,5,6,7,13,165,6,2,1,5,7,3,0,4,12,166,0,0,0,0,0,0,0,0, 0,  0,&
3,2,6,7,0,1,5,4, 6,168,4,0,3,7,5,1,2,6,12,169,1,2,3,0,5,6,7,4,10,170,&
0,0,0,0,0,0,0,0, 0,  0,6,7,3,2,5,4,0,1,12,172,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,6,5,4,7,2,1,0,3, 5,176,&
0,4,5,1,3,7,6,2, 9,177,0,4,5,1,3,7,6,2,14,178,0,0,0,0,0,0,0,0, 0,  0,&
6,5,4,7,2,1,0,3,12,180,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,5,4,7,6,1,0,3,2,11,184,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
7,3,2,6,4,0,1,5, 2,192,6,5,4,7,2,1,0,3, 6,193,7,3,2,6,4,0,1,5, 6,194,&
0,3,7,4,1,2,6,5,10,195,3,2,6,7,0,1,5,4, 5,196,3,2,6,7,0,1,5,4,12,197,&
3,2,6,7,0,1,5,4,14,198,0,0,0,0,0,0,0,0, 0,  0,2,6,7,3,1,5,4,0, 5,200,&
0,3,7,4,1,2,6,5,11,201,2,6,7,3,1,5,4,0,12,202,0,0,0,0,0,0,0,0, 0,  0,&
3,2,6,7,0,1,5,4, 8,204,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,5,4,7,6,1,0,3,2, 5,208,3,7,4,0,2,6,5,1,14,209,&
5,4,7,6,1,0,3,2,12,210,0,0,0,0,0,0,0,0, 0,  0,4,7,6,5,0,3,2,1,11,212,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
6,7,3,2,5,4,0,1, 9,216,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,4,7,6,5,0,3,2,1, 5,224,&
4,7,6,5,0,3,2,1,12,225,1,5,6,2,0,4,7,3,11,226,0,0,0,0,0,0,0,0, 0,  0,&
7,6,5,4,3,2,1,0, 9,228,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,2,6,7,3,1,5,4,0,14,232,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
5,4,7,6,1,0,3,2, 8,240,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,0,0,0,0,0,0,0,0, 0,  0,&
0,0,0,0,0,0,0,0, 0,  0&
/)

!INT CASES[256][10]={
!{0,0,0,0,0,0,0,0, 0,  0},{0,1,2,3,4,5,6,7, 1,  1},{1,2,3,0,5,6,7,4, 1,  2},
!{1,2,3,0,5,6,7,4, 2,  3},{2,3,0,1,6,7,4,5, 1,  4},{0,4,5,1,3,7,6,2, 3,  5},
!{2,3,0,1,6,7,4,5, 2,  6},{3,0,1,2,7,4,5,6, 5,  7},{3,0,1,2,7,4,5,6, 1,  8},
!{0,1,2,3,4,5,6,7, 2,  9},{3,7,4,0,2,6,5,1, 3, 10},{2,3,0,1,6,7,4,5, 5, 11},
!{3,0,1,2,7,4,5,6, 2, 12},{1,2,3,0,5,6,7,4, 5, 13},{0,1,2,3,4,5,6,7, 5, 14},
!{0,1,2,3,4,5,6,7, 8, 15},{4,0,3,7,5,1,2,6, 1, 16},{4,5,1,0,7,6,2,3, 2, 17},
!{1,2,3,0,5,6,7,4, 3, 18},{5,1,0,4,6,2,3,7, 5, 19},{2,3,0,1,6,7,4,5, 4, 20},
!{4,5,1,0,7,6,2,3, 6, 21},{2,3,0,1,6,7,4,5, 6, 22},{3,0,1,2,7,4,5,6,14, 23},
!{4,5,1,0,7,6,2,3, 3, 24},{7,4,0,3,6,5,1,2, 5, 25},{2,6,7,3,1,5,4,0, 7, 26},
!{3,0,1,2,7,4,5,6, 9, 27},{2,6,7,3,1,5,4,0, 6, 28},{4,0,3,7,5,1,2,6,11, 29},
!{0,1,2,3,4,5,6,7,12, 30},{0,0,0,0,0,0,0,0, 0,  0},{5,4,7,6,1,0,3,2, 1, 32},
!{0,3,7,4,1,2,6,5, 3, 33},{1,0,4,5,2,3,7,6, 2, 34},{4,5,1,0,7,6,2,3, 5, 35},
!{2,3,0,1,6,7,4,5, 3, 36},{3,7,4,0,2,6,5,1, 7, 37},{6,2,1,5,7,3,0,4, 5, 38},
!{0,1,2,3,4,5,6,7, 9, 39},{3,0,1,2,7,4,5,6, 4, 40},{3,7,4,0,2,6,5,1, 6, 41},
!{5,6,2,1,4,7,3,0, 6, 42},{3,0,1,2,7,4,5,6,11, 43},{3,0,1,2,7,4,5,6, 6, 44},
!{1,2,3,0,5,6,7,4,12, 45},{0,1,2,3,4,5,6,7,14, 46},{0,0,0,0,0,0,0,0, 0,  0},
!{5,1,0,4,6,2,3,7, 2, 48},{1,0,4,5,2,3,7,6, 5, 49},{0,4,5,1,3,7,6,2, 5, 50},
!{4,5,1,0,7,6,2,3, 8, 51},{4,7,6,5,0,3,2,1, 6, 52},{1,0,4,5,2,3,7,6,12, 53},
!{4,5,1,0,7,6,2,3,11, 54},{0,0,0,0,0,0,0,0, 0,  0},{5,1,0,4,6,2,3,7, 6, 56},
!{1,0,4,5,2,3,7,6,14, 57},{0,4,5,1,3,7,6,2,12, 58},{0,0,0,0,0,0,0,0, 0,  0},
!{4,0,3,7,5,1,2,6,10, 60},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{6,7,3,2,5,4,0,1, 1, 64},{0,1,2,3,4,5,6,7, 4, 65},
!{1,0,4,5,2,3,7,6, 3, 66},{0,4,5,1,3,7,6,2, 6, 67},{2,1,5,6,3,0,4,7, 2, 68},
!{6,7,3,2,5,4,0,1, 6, 69},{5,6,2,1,4,7,3,0, 5, 70},{0,1,2,3,4,5,6,7,11, 71},
!{3,0,1,2,7,4,5,6, 3, 72},{0,1,2,3,4,5,6,7, 6, 73},{7,4,0,3,6,5,1,2, 7, 74},
!{2,3,0,1,6,7,4,5,12, 75},{7,3,2,6,4,0,1,5, 5, 76},{1,2,3,0,5,6,7,4,14, 77},
!{1,2,3,0,5,6,7,4, 9, 78},{0,0,0,0,0,0,0,0, 0,  0},{4,0,3,7,5,1,2,6, 3, 80},
!{0,3,7,4,1,2,6,5, 6, 81},{2,3,0,1,6,7,4,5, 7, 82},{5,1,0,4,6,2,3,7,12, 83},
!{2,1,5,6,3,0,4,7, 6, 84},{0,1,2,3,4,5,6,7,10, 85},{5,6,2,1,4,7,3,0,12, 86},
!{0,0,0,0,0,0,0,0, 0,  0},{0,1,2,3,4,5,6,7, 7, 88},{7,4,0,3,6,5,1,2,12, 89},
!{3,0,1,2,7,4,5,6,13, 90},{0,0,0,0,0,0,0,0, 0,  0},{7,3,2,6,4,0,1,5,12, 92},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{5,4,7,6,1,0,3,2, 2, 96},{6,2,1,5,7,3,0,4, 6, 97},{2,1,5,6,3,0,4,7, 5, 98},
!{2,1,5,6,3,0,4,7,14, 99},{1,5,6,2,0,4,7,3, 5,100},{1,5,6,2,0,4,7,3,12,101},
!{1,5,6,2,0,4,7,3, 8,102},{0,0,0,0,0,0,0,0, 0,  0},{5,4,7,6,1,0,3,2, 6,104},
!{0,4,5,1,3,7,6,2,10,105},{2,1,5,6,3,0,4,7,12,106},{0,0,0,0,0,0,0,0, 0,  0},
!{5,6,2,1,4,7,3,0,11,108},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{7,6,5,4,3,2,1,0, 5,112},{0,4,5,1,3,7,6,2,11,113},
!{6,5,4,7,2,1,0,3, 9,114},{0,0,0,0,0,0,0,0, 0,  0},{1,5,6,2,0,4,7,3,14,116},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{7,6,5,4,3,2,1,0,12,120},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{7,6,5,4,3,2,1,0, 1,128},
!{0,1,2,3,4,5,6,7, 3,129},{1,2,3,0,5,6,7,4, 4,130},{1,2,3,0,5,6,7,4, 6,131},
!{7,4,0,3,6,5,1,2, 3,132},{1,5,6,2,0,4,7,3, 7,133},{1,5,6,2,0,4,7,3, 6,134},
!{3,0,1,2,7,4,5,6,12,135},{3,2,6,7,0,1,5,4, 2,136},{4,0,3,7,5,1,2,6, 5,137},
!{7,4,0,3,6,5,1,2, 6,138},{2,3,0,1,6,7,4,5,14,139},{6,7,3,2,5,4,0,1, 5,140},
!{2,3,0,1,6,7,4,5, 9,141},{1,2,3,0,5,6,7,4,11,142},{0,0,0,0,0,0,0,0, 0,  0},
!{4,0,3,7,5,1,2,6, 2,144},{3,7,4,0,2,6,5,1, 5,145},{7,6,5,4,3,2,1,0, 6,146},
!{1,0,4,5,2,3,7,6,11,147},{4,0,3,7,5,1,2,6, 6,148},{3,7,4,0,2,6,5,1,12,149},
!{1,0,4,5,2,3,7,6,10,150},{0,0,0,0,0,0,0,0, 0,  0},{0,3,7,4,1,2,6,5, 5,152},
!{4,0,3,7,5,1,2,6, 8,153},{0,3,7,4,1,2,6,5,12,154},{0,0,0,0,0,0,0,0, 0,  0},
!{0,3,7,4,1,2,6,5,14,156},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{5,1,0,4,6,2,3,7, 3,160},{1,2,3,0,5,6,7,4, 7,161},
!{1,0,4,5,2,3,7,6, 6,162},{4,5,1,0,7,6,2,3,12,163},{3,0,1,2,7,4,5,6, 7,164},
!{0,1,2,3,4,5,6,7,13,165},{6,2,1,5,7,3,0,4,12,166},{0,0,0,0,0,0,0,0, 0,  0},
!{3,2,6,7,0,1,5,4, 6,168},{4,0,3,7,5,1,2,6,12,169},{1,2,3,0,5,6,7,4,10,170},
!{0,0,0,0,0,0,0,0, 0,  0},{6,7,3,2,5,4,0,1,12,172},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{6,5,4,7,2,1,0,3, 5,176},
!{0,4,5,1,3,7,6,2, 9,177},{0,4,5,1,3,7,6,2,14,178},{0,0,0,0,0,0,0,0, 0,  0},
!{6,5,4,7,2,1,0,3,12,180},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{5,4,7,6,1,0,3,2,11,184},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{7,3,2,6,4,0,1,5, 2,192},{6,5,4,7,2,1,0,3, 6,193},{7,3,2,6,4,0,1,5, 6,194},
!{0,3,7,4,1,2,6,5,10,195},{3,2,6,7,0,1,5,4, 5,196},{3,2,6,7,0,1,5,4,12,197},
!{3,2,6,7,0,1,5,4,14,198},{0,0,0,0,0,0,0,0, 0,  0},{2,6,7,3,1,5,4,0, 5,200},
!{0,3,7,4,1,2,6,5,11,201},{2,6,7,3,1,5,4,0,12,202},{0,0,0,0,0,0,0,0, 0,  0},
!{3,2,6,7,0,1,5,4, 8,204},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{5,4,7,6,1,0,3,2, 5,208},{3,7,4,0,2,6,5,1,14,209},
!{5,4,7,6,1,0,3,2,12,210},{0,0,0,0,0,0,0,0, 0,  0},{4,7,6,5,0,3,2,1,11,212},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{6,7,3,2,5,4,0,1, 9,216},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{4,7,6,5,0,3,2,1, 5,224},
!{4,7,6,5,0,3,2,1,12,225},{1,5,6,2,0,4,7,3,11,226},{0,0,0,0,0,0,0,0, 0,  0},
!{7,6,5,4,3,2,1,0, 9,228},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{2,6,7,3,1,5,4,0,14,232},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{5,4,7,6,1,0,3,2, 8,240},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},{0,0,0,0,0,0,0,0, 0,  0},
!{0,0,0,0,0,0,0,0, 0,  0}
!};

INTEGER, TARGET,DIMENSION(0:14,0:12) :: PATHCCLIST
INTEGER, DIMENSION(0:12,0:14) :: PATHCCLISTT=(/&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   3, 0, 1, 2,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   6,0,1,2,2,3,0,-1,-1,-1,-1,-1,-1,&
   6,0,1,2,3,4,5,-1,-1,-1,-1,-1,-1,&
   6,0,1,2,3,4,5,-1,-1,-1,-1,-1,-1,&
   9,0,1,2,2,3,4,0,2,4,-1,-1,-1,&
   9,0,1,2,2,3,0,4,5,6,-1,-1,-1,&
   9,0,1,2,3,4,5,6,7,8,-1,-1,-1,&
   6,0,1,2,2,3,0,-1,-1,-1,-1,-1,-1,&
  12,0,1,5,1,4,5,1,2,4,2,3,4,&
  12,0,1,2,0,2,3,4,5,6,4,6,7,&
  12,0,1,5,1,4,5,1,2,4,2,3,4,&
  12,0,1,2,3,4,5,3,5,6,3,6,7,&
  12,0,1,2,3,4,5,6,7,8,9,10,11,&
  12,0,1,5,1,4,5,1,2,4,2,3,4&
  /)
!INT PATHCCLIST[15][13]={
!  { 0},
!  { 3,0,1,2},
!  { 6,0,1,2,2,3,0},
!  { 6,0,1,2,3,4,5},
!  { 6,0,1,2,3,4,5},
!  { 9,0,1,2,2,3,4,0,2,4},
!  { 9,0,1,2,2,3,0,4,5,6},
!  { 9,0,1,2,3,4,5,6,7,8},
!  { 6,0,1,2,2,3,0},
!  {12,0,1,5,1,4,5,1,2,4,2,3,4},
!  {12,0,1,2,0,2,3,4,5,6,4,6,7},
!  {12,0,1,5,1,4,5,1,2,4,2,3,4},
!  {12,0,1,2,3,4,5,3,5,6,3,6,7},
!  {12,0,1,2,3,4,5,6,7,8,9,10,11},
!  {12,0,1,5,1,4,5,1,2,4,2,3,4}
!};
INTEGER, TARGET,DIMENSION(0:14,0:19) :: PATHCCLIST2
INTEGER, DIMENSION(0:19,0:14) :: PATHCCLIST2T=(/&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   12, 0, 1, 2, 0, 2, 3, 4, 5, 6, 4, 6, 7,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   15, 0, 1, 2, 0, 2, 3, 4, 5, 6, 7, 8, 9, 7, 9,10,-1,-1,-1,-1,&
   15, 0, 1, 2, 3, 4, 5, 3, 5, 7, 3, 7, 8, 5, 6, 7,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   12, 0, 1, 2, 0, 2, 3, 4, 5, 6, 4, 6, 7,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   12, 0, 1, 2, 3, 4, 6, 3, 6, 7, 4, 5, 6,-1,-1,-1,-1,-1,-1,-1,&
   12, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,-1,-1,-1,-1,-1,-1,-1,&
    0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1&
   /)

!INT PATHCCLIST2[15][19]={
!  { 0},
!  { 0},
!  { 0},
!  { 12,0,1,2,0,2,3,4,5,6,4,6,7},
!  { 0},
!  { 0},
!  { 15,0,1,2,0,2,3,4,5,6,7,8,9,7,9,10},
!  { 15,0,1,2,3,4,5,3,5,7,3,7,8,5,6,7},
!  { 0},
!  { 0},
!  { 12,0,1,2,0,2,3,4,5,6,4,6,7},
!  { 0},
!  { 12,0,1,2,3,4,6,3,6,7,4,5,6},
!  { 12,0,1,2,3,4,5,6,7,8,9,10,11},
!  { 0}
!};

INTEGER, POINTER,DIMENSION(:) :: PATH
INTEGER, TARGET,DIMENSION(0:12,0:14) :: PATHCCWLIST
INTEGER, DIMENSION(0:14,0:12) :: PATHCCWLISTT=(/&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   3, 0, 2, 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   6, 0, 2, 1, 0, 3, 2,-1,-1,-1,-1,-1,-1,&
   6, 0, 2, 1, 3, 5, 4,-1,-1,-1,-1,-1,-1,&
   6, 0, 2, 1, 3, 5, 4,-1,-1,-1,-1,-1,-1,&
   9, 0, 2, 1, 2, 4, 3, 0, 4, 2,-1,-1,-1,&
   9, 0, 2, 1, 0, 3, 2, 4, 6, 5,-1,-1,-1,&
   9, 0, 2, 1, 3, 5, 4, 6, 8, 7,-1,-1,-1,&
   6, 0, 2, 1, 0, 3, 2,-1,-1,-1,-1,-1,-1,&
  12, 0, 5, 1, 1, 5, 4, 1, 4, 2, 2, 4, 3,&
  12, 0, 2, 1, 0, 3, 2, 4, 6, 5, 4, 7, 6,&
  12, 0, 5, 1, 1, 5, 4, 1, 4, 2, 2, 4, 3,&
  12, 0, 2, 1, 3, 5, 4, 3, 6, 5, 3, 7, 6,&
  12, 0, 2, 1, 3, 5, 4, 6, 8, 7, 9,11,10,&
  12, 0, 5, 1, 1, 5, 4, 1, 4, 2, 2, 4, 3&
   /)

!INT PATHCCWLIST[15][13]={
!  { 0},
!  { 3,0,2,1},
!  { 6,0,2,1,0,3,2},
!  { 6,0,2,1,3,5,4},
!  { 6,0,2,1,3,5,4},
!  { 9,0,2,1,2,4,3,0,4,2},
!  { 9,0,2,1,0,3,2,4,6,5},
!  { 9,0,2,1,3,5,4,6,8,7},
!  { 6,0,2,1,0,3,2},
!  {12,0,5,1,1,5,4,1,4,2,2,4,3},
!  {12,0,2,1,0,3,2,4,6,5,4,7,6},
!  {12,0,5,1,1,5,4,1,4,2,2,4,3},
!  {12,0,2,1,3,5,4,3,6,5,3,7,6},
!  {12,0,2,1,3,5,4,6,8,7,9,11,10},
!  {12,0,5,1,1,5,4,1,4,2,2,4,3}
!};

INTEGER, TARGET,DIMENSION(0:18,0:14) :: PATHCCWLIST2
INTEGER, DIMENSION(0:14,0:18) :: PATHCCWLIST2T=(/&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
  12, 0, 2, 1, 0, 3, 2, 4, 6, 5, 4, 7, 6,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
  15, 0, 2, 1, 0, 3, 2, 4, 6, 5, 7, 9, 8, 7,10, 9,-1,-1,-1,&
  15, 0, 2, 1, 3, 5, 4, 3, 7, 5, 3, 8, 7, 5, 7, 6,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
  12, 0, 2, 1, 0, 3, 2, 4, 6, 5, 4, 7, 6,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
  12, 0, 2, 1, 3, 6, 4, 3, 7, 6, 4, 6, 5,-1,-1,-1,-1,-1,-1,&
  12, 0, 2, 1, 3, 5, 4, 6, 8, 7, 9,11,10,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1&
  /)

!INT PATHCCWLIST2[15][19]={
!  { 0},
!  { 0},
!  { 0},
!  { 12,0,2,1,0,3,2,4,6,5,4,7,6},
!  { 0},
!  { 0},
!  { 15,0,2,1,0,3,2,4,6,5,7,9,8,7,10,9},
!  { 15,0,2,1,3,5,4,3,7,5,3,8,7,5,7,6},
!  { 0},
!  { 0},
!  { 12,0,2,1,0,3,2,4,6,5,4,7,6},
!  { 0},
!  { 12,0,2,1,3,6,4,3,7,6,4,6,5},
!  { 12,0,2,1,3,5,4,6,8,7,9,11,10},
!  { 0}
!};

INTEGER, POINTER,DIMENSION(:) :: EDGES
INTEGER, TARGET,DIMENSION(0:12,0:14) :: EDGELIST
INTEGER, DIMENSION(0:14,0:12) :: EDGELISTT=(/&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   3, 0, 4, 3,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   4, 0, 4, 7, 2,-1,-1,-1,-1,-1,-1,-1,-1,&
   6, 0, 4, 3, 7,11,10,-1,-1,-1,-1,-1,-1,&
   6, 0, 4, 3, 6,10, 9,-1,-1,-1,-1,-1,-1,&
   5, 0, 3, 7, 6, 5,-1,-1,-1,-1,-1,-1,-1,&
   7, 0, 4, 7, 2, 6,10, 9,-1,-1,-1,-1,-1,&
   9, 4, 8,11, 2, 3, 7, 6,10, 9,-1,-1,-1,&
   4, 4, 7, 6, 5,-1,-1,-1,-1,-1,-1,-1,-1,&
   6, 2, 6, 9, 8, 4, 3,-1,-1,-1,-1,-1,-1,&
   8, 0, 8,11, 3,10, 9, 1, 2,-1,-1,-1,-1,&
   6, 4, 3, 2,10, 9, 5,-1,-1,-1,-1,-1,-1,&
   8, 4, 8,11, 0, 3, 7, 6, 5,-1,-1,-1,-1,&
  12, 0, 4, 3, 7,11,10, 2, 6, 1, 8, 5, 9,&
   6, 3, 7, 6, 9, 8, 0,-1,-1,-1,-1,-1,-1&
  /)

!INT EDGELIST[15][13]={
!  { 0                             },
!  { 3,0,4, 3                      },
!  { 4,0,4, 7, 2                   },
!  { 6,0,4, 3, 7,11,10             },
!  { 6,0,4, 3, 6,10, 9             },
!  { 5,0,3, 7, 6, 5                },
!  { 7,0,4, 7, 2, 6,10,9           },
!  { 9,4,8,11, 2, 3, 7,6,10,9      },
!  { 4,4,7, 6, 5                   },
!  { 6,2,6, 9, 8, 4, 3             },
!  { 8,0,8,11, 3,10, 9,1, 2        },
!  { 6,4,3, 2,10, 9, 5             },
!  { 8,4,8,11, 0, 3, 7,6, 5        },
!  {12,0,4, 3, 7,11,10,2, 6,1,8,5,9},
!  { 6,3,7, 6, 9, 8, 0             }
!};

INTEGER, TARGET,DIMENSION(0:15,0:14) :: EDGELIST2
INTEGER, DIMENSION(0:14,0:15) :: EDGELIST2T=(/&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   8, 3, 0,10, 7, 0, 4,11,10,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
  11, 7,10, 9, 4, 0, 4, 9, 0, 9, 6, 2,-1,-1,-1,-1,&
   9, 7,10,11, 3, 4, 8, 9, 6, 2,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   8, 0, 8, 9, 1, 3, 2,10,11,-1,-1,-1,-1,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,&
   8, 0, 3, 4, 8,11, 7, 6, 5,-1,-1,-1,-1,-1,-1,-1,&
  12, 4,11, 8, 0, 5, 1, 7, 3, 2, 9,10, 6,-1,-1,-1,&
   0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1&
  /)
  
!INT EDGELIST2[15][16]={
!  { 0                             },
!  { 0},
!  { 0},
!  { 8,3,0,10,7,0,4,11,10},
!  { 0},
!  { 0},
!  { 11, 7,10,9,4,0,4,9,0,9,6,2},
!  { 9,7,10,11,3,4,8,9,6,2},
!  { 0},
!  { 0},
!  { 8,0,8,9,1,3,2,10,11},
!  { 0},
!  { 8,0,3,4,8,11,7,6,5},
!  { 12,4,11,8,0,5,1,7,3,2,9,10,6},
!  { 0}

INTEGER :: VMIN, VMAX
INTEGER :: CASENUM, BIGGER, SIGN, N
INTEGER, DIMENSION(0:7) :: PRODS=(/1,2,4,8,16,32,64,128/);
REAL, DIMENSION(0:7) :: XXVAL,YYVAL,ZZVAL
INTEGER, DIMENSION(0:3) :: IXMIN=(/0,1,4,5/), IXMAX=(/2,3,6,7/)
INTEGER, DIMENSION(0:3) :: IYMIN=(/0,3,4,7/), IYMAX=(/1,2,5,6/)
INTEGER, DIMENSION(0:3) :: IZMIN=(/0,1,2,3/), IZMAX=(/4,5,6,7/)
INTEGER :: TYPE2,THISTYPE2
INTEGER :: NEDGES,NPATH
INTEGER :: OUTOFBOUNDS, EDGE, V1, V2
REAL :: VAL1, VAL2, DENOM, FACTOR
REAL :: XX, YY, ZZ

EDGE2VERTEX=TRANSPOSE(EDGE2VERTEXT)
CASES=TRANSPOSE(CASEST)
PATHCCLIST=TRANSPOSE(PATHCCLISTT)
PATHCCLIST2=TRANSPOSE(PATHCCLIST2T)
PATHCCWLIST=TRANSPOSE(PATHCCWLISTT)
PATHCCWLIST2=TRANSPOSE(PATHCCWLIST2T)
EDGELIST=TRANSPOSE(EDGELISTT)
EDGELIST2=TRANSPOSE(EDGELIST2T)

CLOSESTNODES=0
VMIN=MIN(VALS(0),VALS(1),VALS(2),VALS(3),VALS(4),VALS(5),VALS(6),VALS(7))
VMAX=MAX(VALS(0),VALS(1),VALS(2),VALS(3),VALS(4),VALS(5),VALS(6),VALS(7))


NXYZV=0
NTRIS=0

IF(VMIN>LEVEL.OR.VMAX<LEVEL)THEN
  FGETISOBOX=NTRIS
  RETURN
ENDIF

CASENUM=0
BIGGER=0
SIGN=1

DO N = 0, 7
  IF(VALS(N)>LEVEL)THEN
    BIGGER=BIGGER+1
    CASENUM = CASENUM + PRODS(N);
  ENDIF
END DO

! THERE ARE MORE NODES GREATER THAN THE ISO-SURFACE LEVEL THAN BELOW, SO 
!   SOLVE THE COMPLEMENTARY PROBLEM 

IF(BIGGER.GT.4)THEN
  SIGN=-1
  CASENUM=0
  DO N=0, 7
    IF(VALS(N)<LEVEL)THEN
      CASENUM = CASENUM + PRODS(N)
    ENDIF
  END DO
ENDIF

! STUFF MIN AND MAX GRID DATA INTO A MORE CONVENIENT FORM 
!  ASSUMING THE FOLLOWING GRID NUMBERING SCHEME

!       5-------6
!     / |      /| 
!   /   |     / | 
!  4 -------7   |
!  |    |   |   |  
!  Z    1---|---2
!  |  Y     |  /
!  |/       |/
!  0--X-----3     


DO N=0, 3
  XXVAL(IXMIN(N)) = X(0);
  XXVAL(IXMAX(N)) = X(1);
  YYVAL(IYMIN(N)) = Y(0);
  YYVAL(IYMAX(N)) = Y(1);
  ZZVAL(IZMIN(N)) = Z(0);
  ZZVAL(IZMAX(N)) = Z(1);
END DO

 IF(CASENUM<=0.OR.CASENUM>=255)THEN ! NO ISO-SURFACE 
   FGETISOBOX=0
   RETURN
 ENDIF

  CASE2 => CASES(CASENUM,0:9)
  TYPE2 = CASE2(8);
  IF(TYPE2==0)THEN
    FGETISOBOX=NTRIS
    RETURN
  ENDIF

  IF(COMPCASE(TYPE2).EQ.-1)THEN
    THISTYPE2=SIGN
  ELSE
    THISTYPE2=1
  ENDIF
  
  IF(THISTYPE2.NE.-1)THEN
    !EDGES = &(EDGELIST[TYPE][1]);
    EDGES => EDGELIST(TYPE2,1:14)
    IF(SIGN.GE.0)THEN
     ! PATH = &(PATHCCLIST[TYPE][1])   !  CONSTRUCT TRIANGLES CLOCK WISE
      PATH => PATHCCLIST(TYPE2,1:12)
    ELSE
     ! PATH = &(PATHCCWLIST[TYPE][1])  !  CONSTRUCT TRIANGLES COUNTER CLOCKWISE 
      PATH => PATHCCWLIST(TYPE2,1:14)
    ENDIF
  ELSE
    !EDGES = &(EDGELIST2[TYPE][1]);
    EDGES => EDGELIST2(TYPE2,1:14)
    IF(SIGN.GT.0)THEN
     ! PATH = &(PATHCCLIST2[TYPE][1])  !  CONSTRUCT TRIANGLES CLOCK WISE
      PATH => PATHCCLIST2(TYPE2,1:19)
    ELSE
     ! PATH = &(PATHCCWLIST2[TYPE][1]) !  CONSTRUCT TRIANGLES COUNTER CLOCKWISE
      PATH => PATHCCWLIST2(TYPE2,1:14)
    ENDIF   
  ENDIF
  NPATH = PATH(-1);
  NEDGES = EDGES(-1);
  
  OUTOFBOUNDS=0
  DO N=0,NEDGES-1
    EDGE = EDGES(N)
    V1 = CASE2(EDGE2VERTEX(EDGE,0));
    V2 = CASE2(EDGE2VERTEX(EDGE,1));
    VAL1 = VALS(V1)-LEVEL
    VAL2 = VALS(V2)-LEVEL
    DENOM = VAL2 - VAL1
    FACTOR = 0.5
    IF(DENOM.NE.0.0)FACTOR = -VAL1/DENOM
    IF(FACTOR.LT.0.5)THEN
      CLOSESTNODES(3*N)=NODEINDEXES(3*V1)
      CLOSESTNODES(3*N+1)=NODEINDEXES(3*V1+1)
      CLOSESTNODES(3*N+2)=NODEINDEXES(3*V1+2)
    ELSE
      CLOSESTNODES(3*N)=NODEINDEXES(3*V2)
      CLOSESTNODES(3*N+1)=NODEINDEXES(3*V2+1)
      CLOSESTNODES(3*N+2)=NODEINDEXES(3*V2+2)
    ENDIF
    IF(FACTOR.GT.1.0)THEN
      ! FACTOR=1.0
      OUTOFBOUNDS=1
    ENDIF
    IF(FACTOR.LT.0.0)THEN
      ! FACTOR=0.0
      OUTOFBOUNDS=1
    ENDIF
    XX = FMIX(FACTOR,XXVAL(V2),XXVAL(V1));
    YY = FMIX(FACTOR,YYVAL(V2),YYVAL(V1));
    ZZ = FMIX(FACTOR,ZZVAL(V2),ZZVAL(V1));
    XYZV(3*N) = XX;
    XYZV(3*N+1) = YY;
    XYZV(3*N+2) = ZZ;
    IF(HAVE_TVALS.EQ.1)THEN
      TV(N) = FMIX(FACTOR,TVALS(V2),TVALS(V1));
    ENDIF

  END DO
  IF(OUTOFBOUNDS.EQ.1)THEN
    WRITE(6,*)"*** WARNING - COMPUTED ISOSURFACE VERTICES ARE OUT OF BOUNDS FOR :"
    WRITE(6,*)"CASE NUMBER=",CASENUM," LEVEL=",LEVEL
    WRITE(6,*)"VALUES="
    DO N=0,7
      WRITE(6,*)VALS(N)
    END DO
    WRITE(6,*)"X=",X(0),X(1),"Y=",Y(0),Y(1),"Z=",Z(0),Z(1)
  ENDIF

! COPY COORDINATES TO OUTPUT ARRAY

  NXYZV = NEDGES;
  NTRIS = NPATH;
  DO N=0,NPATH-1
    TRIS(N) = PATH(N)
  END DO
  FGETISOBOX=NTRIS
  RETURN
END FUNCTION FGETISOBOX

! ------------------ MERGEGEOM ------------------------

SUBROUTINE MERGEGEOM(TRIS1,NTRIS1,NODES1,NNODES1,TRIS2,NTRIS2,NODES2,NNODES2)
  INTEGER, INTENT(IN), DIMENSION(:), POINTER :: TRIS1
  INTEGER, INTENT(IN) :: NTRIS1
  REAL, INTENT(IN), DIMENSION(:), POINTER :: NODES1
  INTEGER, INTENT(IN) :: NNODES1
  INTEGER, INTENT(INOUT), DIMENSION(:), POINTER :: TRIS2
  INTEGER, INTENT(INOUT) :: NTRIS2
  REAL, INTENT(INOUT), DIMENSION(:), POINTER :: NODES2
  INTEGER, INTENT(INOUT) :: NNODES2
  
  INTEGER :: NNODES_NEW, NTRIS_NEW, N
  
  NNODES_NEW = NNODES1 + NNODES2
  NTRIS_NEW = NTRIS1 + NTRIS2
  
  CALL REALLOC_F(NODES1,3*NNODES1,3*NNODES_NEW)
  CALL REALLOC_I(TRIS1,3*NTRIS1,3*NTRIS_NEW)
  NODES1(3*NNODES1:3*NNODES_NEW-1)=NODES2(0:3*NNODES2-1)
  TRIS1(3*NTRIS1:3*NTRIS_NEW-1)=TRIS2(0:3*NTRIS2-1)
  DO N=0,3*NTRIS2-1
    TRIS1(3*NTRIS1+N) = TRIS1(3*NTRIS1+N) + NNODES1
  END DO
END SUBROUTINE MERGEGEOM

! ------------------ REALLOC_I ------------------------

SUBROUTINE REALLOC_I(VALS,OLDSIZE,NEWSIZE)
  INTEGER, INTENT(INOUT), DIMENSION(:), POINTER :: VALS
  INTEGER, INTENT(IN) :: OLDSIZE, NEWSIZE
  INTEGER, DIMENSION(:), POINTER :: VALS_TEMP
  
  IF(OLDSIZE.GT.0)THEN
    NULLIFY(VALS_TEMP)
    ALLOCATE(VALS_TEMP(OLDSIZE))
    VALS_TEMP(0:OLDSIZE-1) = VALS(0:OLDSIZE-1)
    DEALLOCATE(VALS)
  ENDIF
  ALLOCATE(VALS(NEWSIZE))
  IF(OLDSIZE.GT.0)THEN
    VALS(0:OLDSIZE-1)=VALS_TEMP(0:OLDSIZE-1)
    DEALLOCATE(VALS_TEMP)
  ENDIF
  RETURN
END SUBROUTINE REALLOC_I

! ------------------ REALLOC_F ------------------------

SUBROUTINE REALLOC_F(VALS,OLDSIZE,NEWSIZE)
  REAL, INTENT(INOUT), DIMENSION(:), POINTER :: VALS
  INTEGER, INTENT(IN) :: OLDSIZE, NEWSIZE
  REAL, DIMENSION(:), POINTER :: VALS_TEMP
  
  IF(OLDSIZE.GT.0)THEN
    NULLIFY(VALS_TEMP)
    ALLOCATE(VALS_TEMP(OLDSIZE))
    VALS_TEMP(0:OLDSIZE-1) = VALS(0:OLDSIZE-1)
    DEALLOCATE(VALS)
  ENDIF
  ALLOCATE(VALS(NEWSIZE))
  IF(OLDSIZE.GT.0)THEN
    VALS(0:OLDSIZE-1)=VALS_TEMP(0:OLDSIZE-1)
    DEALLOCATE(VALS_TEMP)
  ENDIF
  RETURN
END SUBROUTINE REALLOC_F

! ------------------ RLE_F ------------------------

INTEGER FUNCTION RLE_F(BUFFER_IN, NCHARS_IN, BUFFER_OUT)
  IMPLICIT NONE
  
  CHARACTER(LEN=1), INTENT(IN), DIMENSION(0:NCHARS_IN) :: BUFFER_IN
  INTEGER, INTENT(IN) :: NCHARS_IN
  CHARACTER(LEN=1), INTENT(OUT), DIMENSION(:), POINTER :: BUFFER_OUT
  
  CHARACTER(LEN=1) :: MARK=CHAR(255),THISCHAR,LASTCHAR
  INTEGER :: N,N2,NREPEATS
  
   NREPEATS=1
   LASTCHAR=MARK
   N2=0
   DO N=0,NCHARS_IN-1
     THISCHAR=BUFFER_IN(N)
     IF(THISCHAR.EQ.LASTCHAR)THEN
       NREPEATS=NREPEATS+1
     ELSE
       NREPEATS=1
     ENDIF
     IF(NREPEATS.GE.1.AND.NREPEATS.LE.3)THEN
       BUFFER_OUT(N2)=THISCHAR
       LASTCHAR=THISCHAR
     ELSE 
       IF(NREPEATS.EQ.4)THEN
         N2=N2-3
         BUFFER_OUT(N2)=MARK
         BUFFER_OUT(N2+1)=THISCHAR
         N2=N2+2
       ELSE
         N2=N2-1
       ENDIF
       BUFFER_OUT(N2)=CHAR(NREPEATS)
       IF(NREPEATS.EQ.254)THEN
         NREPEATS=1
         LASTCHAR=THISCHAR
       ENDIF
     ENDIF
     N2=N2+1
   END DO
   RLE_F=N2
   RETURN
END FUNCTION RLE_F


